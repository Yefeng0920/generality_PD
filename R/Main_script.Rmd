---
title: "Interpreting prediction intervals and distributions for decoding biological generality in meta-analysis"
output: html_document
date: 'Last update: 29 Aug 2024'
---


# Setup

```{r setup, echo=FALSE, warning=FALSE}
# tidy
 # rm(list=ls())
 # graphics.off()
# preparing workspace
knitr::opts_chunk$set(echo = TRUE, include = TRUE)
# loading packages
pacman::p_load(knitr, # knit markdown
               readxl, 
               readr, 
               metafor, 
               dplyr, 
               tidyverse, 
               patchwork, 
               cowplot, 
               ggpubr,
               gridExtra,
               gridGraphics,
               here,
               lme4,
               car,
               ggthemes,
               wesanderson,
               raincloudplots,
               RColorBrewer,
               ggbreak,
               vcd,
               statpsych
               )
# function
source(here("function","custom_function.R"))
```

# Load data

Load the raw data and pre-fitted models. The R code and processes of the model fitting can be found at the supplementary information of the following paper:

Yang, Y., Noble, D., Spake, R., Senior, A., Lagisz, M., & Nakagawa, S. (2023). Measuring biological generality in meta-analysis: a pluralistic approach to heterogeneity quantification and stratification. https://doi.org/10.32942/x2rg7x

```{r}
# raw data
dat_list <- readRDS(here("Data", "dat_list.Rds"))
dat_list_rob <- readRDS(here("Data", "dat_list_rob.Rds"))
# fitted models
model_all <- readRDS(here("Data", "mod_fitted.Rds"))
model_all_rob <- readRDS(here("Data", "mod_rob_fitted.Rds"))
# add effect size measures 
names(model_all) <- sapply(dat_list, function(x) x$grouped_es[1])
names(model_all_rob) <- c(rep("lnRR", 7), rep("lnRR", 6), rep("SMD", 13), rep("SMD", 15), rep("Zr", 14))
# combine
model_all_PD <- c(model_all, model_all_rob)
```


# Default analysis

Calculate necessary statistics for the computation of PD and PI.

## PD related statistics

```{r}
#************************************************#
#----------------------PD----------------------#
#************************************************#

# each model
threshold_list <- lapply(model_all_PD, calculate_threshold)

# dataframe
threshold_df <- bind_rows(threshold_list, .id = "ES_index")

# reshape
threshold_df_wide <- pivot_wider(data = threshold_df, 
                                   names_from = group, 
                                   values_from = threshold)

PD_data <- threshold_df_wide %>% select(PD_t, PD_b, PD_w)
PD_data <- as.data.frame(lapply(PD_data, na.omit))
PD_data$es <- names(model_all_PD)

# model estimates
mod_stats <- data.frame(beta = sapply(model_all_PD, function(x) x$beta[1]),
                        beta.se = sapply(model_all_PD, function(x) x$se[1]),
                        beta.p = sapply(model_all_PD, function(x) x$pval[1]),
                        df = sapply(model_all_PD, function(x) x$ddf[1]),
                        CIL = sapply(model_all_PD, function(x) x$ci.lb[1]),
                        CIU = sapply(model_all_PD, function(x) x$ci.ub[1]),
                        sigma2_t = sapply(model_all_PD, function(x) sum(x$sigma2)),
                        sigma2_b = sapply(model_all_PD, function(x) x$sigma2[1]),
                        sigma2_w = sapply(model_all_PD, function(x) x$sigma2[2]),
                        QEp = sapply(model_all_PD, function(x) x$QEp),
                        I2_t = sapply(model_all_PD, function(x) i2_ml(x)[[1]]),
                        I2_b = sapply(model_all_PD, function(x) i2_ml(x)[[2]]),
                        I2_w = sapply(model_all_PD, function(x) i2_ml(x)[[3]]))




# typical sampling variance
mod_stats <- mod_stats %>% mutate(Vbar = sapply(model_all_PD, function(x) sigma2_v(x)))
# ratio
mod_stats <- mod_stats %>% mutate(sigma2_t_Vbar = sigma2_t / Vbar,
                                  sigma2_b_Vbar = sigma2_b / Vbar,
                                  sigma2_w_Vbar = sigma2_w / Vbar)


# combine
PD_data <- cbind(mod_stats, PD_data)
# CV
PD_data <- PD_data %>% mutate(CV_t = sqrt(sigma2_t) / abs(beta),
                              CV_b = sqrt(sigma2_b) / abs(beta),
                              CV_w = sqrt(sigma2_w) / abs(beta))
```

## PI related statistics

```{r}
#************************************************#
#----------------------PI----------------------#
#************************************************#
PD_data <- PD_data %>% 
  mutate(PIL_t = sapply(model_all_PD, function(x) x$beta[1]-qt(1-0.05/2,df=x$ddf[[1]])*sqrt(sum(x$sigma2)+x$se^2))) %>%
  mutate(PIU_t = sapply(model_all_PD, function(x) x$beta[1]+qt(1-0.05/2,df=x$ddf[[1]])*sqrt(sum(x$sigma2)+x$se^2))) %>%
  mutate(PIL_b = sapply(model_all_PD, function(x) x$beta[1]-qt(1-0.05/2,df=x$ddf[[1]])*sqrt(x$sigma2[1]+x$se^2))) %>%
  mutate(PIU_b = sapply(model_all_PD, function(x) x$beta[1]+qt(1-0.05/2,df=x$ddf[[1]])*sqrt(x$sigma2[1]+x$se^2))) %>% 
  mutate(PIL_w = sapply(model_all_PD, function(x) x$beta[1]-qt(1-0.05/2,df=x$ddf[[1]])*sqrt(x$sigma2[2]+x$se^2))) %>%
  mutate(PIU_w = sapply(model_all_PD, function(x) x$beta[1]+qt(1-0.05/2,df=x$ddf[[1]])*sqrt(x$sigma2[2]+x$se^2)))
```


# Scenario analysis

## Default

Calculate PDs and PIs whilst ignoring the hierarchical data structure.

### PI
```{r}
## sig overall effect
length(which(PD_data$beta.p < 0.05)) # 321 / nrow(PD_data) - 63%
## or, equivalently, 
length(which(PD_data$CIL*PD_data$CIU > 0))

## sig total PI 
length(which(PD_data$PIL_t*PD_data$PIU_t > 0)) # 21 / nrow(PD_data) - 6%


# sig based on PI
PD_data <- PD_data %>% 
  mutate(sig_t = case_when(PD_data$PIL_t*PD_data$PIU_t > 0 ~ 'None-null',
          PD_data$PIL_t*PD_data$PIU_t < 0 ~ 'Null effect')) %>%
  mutate(sig_b = case_when(PD_data$PIL_b*PD_data$PIU_b > 0 ~ 'None-null',
          PD_data$PIL_b*PD_data$PIU_b < 0 ~ 'Null effect'))

# scenario where between-study level is lower than within-study level
PD_data_b <- filter(PD_data, sigma2_b < sigma2_w) 
## sig overall effect
length(which(PD_data_b$beta.p < 0.05)) # 162 / nrow(PD_data_b) - 67%
## sig PI total
length(which(PD_data_b$PIL_t*PD_data_b$PIU_t > 0)) # 13 / 162 - 8%
## sig PI between
length(which(PD_data_b$PIL_b*PD_data_b$PIU_b > 0)) # 59 / 162 - 36%
```


### PD

```{r}
# total
PD_data %>%
  summarize(Min = min(PD_t),
            Q1 = quantile(PD_t, probs = 0.25),
            median = quantile(PD_t, probs = 0.50),
            Q3 = quantile(PD_t, probs = 0.75),
            Max = max(PD_t))
```


## Decomposition

Calculate PDs and PIs whilst considering the hierarchical data structure.

### PI

```{r}
## sig between PI 
length(which(PD_data$PIL_b*PD_data$PIU_b > 0)) # 71 / 321 - 22%
## sig effect size PI 
length(which(PD_data$PIL_w*PD_data$PIU_w > 0)) # 81 / 321 - 25%

# summary
## total
PD_data %>%
  summarize(Q1 = quantile(PD_t, probs = 0.25),
            medium = quantile(PD_t, probs = 0.50),
            Q3 = quantile(PD_t, probs = 0.75),
            mean = mean(PD_t, na.rm = TRUE))

## between
PD_data %>%
  summarize(Q1 = quantile(PD_b, probs = 0.25),
            medium = quantile(PD_b, probs = 0.50),
            Q3 = quantile(PD_b, probs = 0.75),
            mean = mean(PD_b, na.rm = TRUE))
```

### PD

```{r}
# summary
## total
PD_data %>%
  summarize(Q1 = quantile(PD_t, probs = 0.25),
            medium = quantile(PD_t, probs = 0.50),
            Q3 = quantile(PD_t, probs = 0.75),
            mean = mean(PD_t, na.rm = TRUE))

## between
PD_data %>%
  summarize(Q1 = quantile(PD_b, probs = 0.25),
            medium = quantile(PD_b, probs = 0.50),
            Q3 = quantile(PD_b, probs = 0.75),
            mean = mean(PD_b, na.rm = TRUE))

## within
PD_data %>%
  summarize(Q1 = quantile(PD_w, probs = 0.25),
            medium = quantile(PD_w, probs = 0.50),
            Q3 = quantile(PD_w, probs = 0.75),
            mean = mean(PD_w, na.rm = TRUE))
```


# Validation

Validate the method we used to compute PD. There are three theoretically equivalent methods for the computation of PD.

## Equivalence between different approaches

```{r}
# set up parameters
## overall effect
theta <- 0.5

## SD in effect sizes
sigma <- 0.25

## dfs
dfs <- 20

## cutoff for meaningful effect
cutoff <- 0.2

# (1) integrating over the the density of the  distribution
(1 - integrate(dlst, Inf, cutoff, df = dfs, mu = theta, sigma = sigma)$value)*100

# (2) using the cumulative distribution function (CDF) 
plst(cutoff, df = dfs, mu = theta, sigma = sigma, lower.tail = F)

# (3) simulation
es.sim <- rlst(10e5, df = dfs, mu = theta, sigma = sigma)
mean(es.sim > cutoff)
```


## Integration

```{r}
# add lower bound of CI as the cutoff
threshold_df$ci.lb <- unlist(lapply(model_all_PD, function(model) rep(model$ci.lb, 3)))
# add dfs as well
threshold_df$df <- unlist(lapply(model_all_PD, function(model) rep(model$k.all - 1, 3)))

# integrate over the density the Student t distribution
# function to perform integration
integration <- function(mean, ci.lb, df, sd) {
  if (mean > 0) {
    return( (1 - integrate(dlst, -Inf, ci.lb, df = df, mu = mean, sigma = sd)$value)*100 )
  } else {
    return( (1 - integrate(dlst, Inf, ci.lb, df = df, mu = mean, sigma = sd)$value)*100 )
  }
}

threshold_df$threshold_validation <- mapply(integration, 
                                          threshold_df$mean, 
                                          threshold_df$ci.lb, 
                                          threshold_df$df, 
                                          threshold_df$sd)
```

## Simulation

```{r}
# example
es.sim <- rlst(10e5, df = threshold_df$df[1], mu = threshold_df$mean[1], sigma = threshold_df$sd[1])
mean(es.sim > threshold_df$ci.lb[1]) * 100

set.seed(2024)
threshold_df$threshold_validation2 <- NA
for (i in 1:nrow(threshold_df)) {
  df_i <- threshold_df$df[i]
  mean_i <- threshold_df$mean[i]
  sd_i <- threshold_df$sd[i]
  ci_lb_i <- threshold_df$ci.lb[i]
  es.sim <- rlst(10e5, df = df_i, mu = mean_i, sigma = sd_i)
  threshold_validation_i <- mean(es.sim > ci_lb_i) * 100
  threshold_df$threshold_validation2[i] <- threshold_validation_i
}

```


# Sensitivity analysis

We conducted two sensitivity analyses: 

(1) using different SESOIs,

(2) PDs and PIs of different effect size measures.

## Different SESOIs

Besides using the lower bound of the 95% CI, we also used the conventional cutoffs for a ‘small effect’ (0.2 for Cohen’s d, and 0.1 for Fisher’s Zr) as the SESOI.

```{r}
# add Cohen's rule-of-thumb as the cutoff
## subset of Cohen's d
threshold_df_SMD <- filter(threshold_df, ES_index == "SMD")
## subset of Zr
threshold_df_Zr <- filter(threshold_df, ES_index == "Zr")
## subset of lnRR
threshold_df_lnRR <- filter(threshold_df, ES_index == "lnRR")

## small effect
threshold_df_SMD$Cohen <- rep(0.2, nrow(threshold_df_SMD))
threshold_df_Zr$Cohen <- rep(0.1, nrow(threshold_df_Zr)) # Zr = r in terms of small effect / r2z(0.1)
threshold_df_lnRR$p10 <- rep(0.1, nrow(threshold_df_lnRR)) # exp(0.1) = 10%

## adjust the sign of small effect according to the sign of the mean
threshold_df_SMD <- threshold_df_SMD %>%
  mutate(Cohen = ifelse(mean > 0, Cohen, -Cohen))

threshold_df_Zr <- threshold_df_Zr %>%
  mutate(Cohen = ifelse(mean > 0, Cohen, -Cohen))

threshold_df_lnRR <- threshold_df_lnRR %>%
  mutate(p10 = ifelse(mean > 0, p10, -p10))

## integrate over the density the Student t distribution
## SMD
threshold_df_SMD$threshold_Cohen <- mapply(integration, 
                                          threshold_df_SMD$mean, 
                                          threshold_df_SMD$Cohen, 
                                          threshold_df_SMD$df, 
                                          threshold_df_SMD$sd)

## Zr
threshold_df_Zr$threshold_Cohen <- mapply(integration, 
                                          threshold_df_Zr$mean, 
                                          threshold_df_Zr$Cohen, 
                                          threshold_df_Zr$df, 
                                          threshold_df_Zr$sd)
threshold_df_Zr[threshold_df_Zr$group=="PD_b",]$threshold_Cohen %>% summary()

# combine SMD and Zr
threshold_df_SMD_Zr <- rbind(threshold_df_SMD, threshold_df_Zr)

## lnRR
threshold_df_lnRR$threshold_p10 <- mapply(integration, 
                                          threshold_df_lnRR$mean, 
                                          threshold_df_lnRR$p10, 
                                          threshold_df_lnRR$df, 
                                          threshold_df_lnRR$sd)



```


## Different effect measures

```{r}
# add measures
PD_data$ES_index <- names(model_all_PD)
# SMD
PD_data_SMD <- subset(PD_data, ES_index == "SMD")
## sig total PI
length(which(PD_data_SMD$PIL_t*PD_data_SMD$PIU_t > 0))
## sig between PI 
length(which(PD_data_SMD$PIL_b*PD_data_SMD$PIU_b > 0)) # length(which(PD_data_SMD$PIL_b*PD_data_SMD$PIU_b > 0)) / length(which(PD_data_SMD$beta.p < 0.05))
## sig effect size PI 
length(which(PD_data_SMD$PIL_w*PD_data_SMD$PIU_w > 0)) # length(which(PD_data_SMD$PIL_w*PD_data_SMD$PIU_w > 0)) / length(which(PD_data_SMD$beta.p < 0.05))

## total
PD_data_SMD %>%
  summarize(Q1 = quantile(PD_t, probs = 0.25),
            medium = quantile(PD_t, probs = 0.50),
            Q3 = quantile(PD_t, probs = 0.75),
            mean = mean(PD_t, na.rm = TRUE))

## between
PD_data_SMD %>%
  summarize(Q1 = quantile(PD_b, probs = 0.25),
            medium = quantile(PD_b, probs = 0.50),
            Q3 = quantile(PD_b, probs = 0.75),
            mean = mean(PD_b, na.rm = TRUE))



# Zr
PD_data_Zr <- subset(PD_data, ES_index == "Zr") 
## sig total PI
length(which(PD_data_Zr$PIL_t*PD_data_Zr$PIU_t > 0))
## sig between PI 
length(which(PD_data_Zr$PIL_b*PD_data_Zr$PIU_b > 0))  # length(which(PD_data_Zr$PIL_b*PD_data_Zr$PIU_b > 0)) / length(which(PD_data_Zr$beta.p < 0.05))
## sig effect size PI 
length(which(PD_data_Zr$PIL_w*PD_data_Zr$PIU_w > 0)) # length(which(PD_data_Zr$PIL_w*PD_data_Zr$PIU_w > 0)) / length(which(PD_data_Zr$beta.p < 0.05))

## total
PD_data_Zr %>%
  summarize(Q1 = quantile(PD_t, probs = 0.25),
            medium = quantile(PD_t, probs = 0.50),
            Q3 = quantile(PD_t, probs = 0.75),
            mean = mean(PD_t, na.rm = TRUE))

## between
PD_data_Zr %>%
  summarize(Q1 = quantile(PD_b, probs = 0.25),
            medium = quantile(PD_b, probs = 0.50),
            Q3 = quantile(PD_b, probs = 0.75),
            mean = mean(PD_b, na.rm = TRUE))


# lnRR
PD_data_lnRR <- subset(PD_data, ES_index == "lnRR")
## sig total PI
length(which(PD_data_lnRR$PIL_t*PD_data_lnRR$PIU_t > 0))
## sig between PI 
length(which(PD_data_lnRR$PIL_b*PD_data_lnRR$PIU_b > 0))  # length(which(PD_data_lnRR$PIL_b*PD_data_lnRR$PIU_b > 0)) / length(which(PD_data_lnRR$beta.p < 0.05))
## sig effect size PI 
length(which(PD_data_lnRR$PIL_w*PD_data_lnRR$PIU_w > 0)) # length(which(PD_data_lnRR$PIL_w*PD_data_lnRR$PIU_w > 0)) / length(which(PD_data_lnRR$beta.p < 0.05))

## total
PD_data_lnRR %>%
  summarize(Q1 = quantile(PD_t, probs = 0.25),
            medium = quantile(PD_t, probs = 0.50),
            Q3 = quantile(PD_t, probs = 0.75),
            mean = mean(PD_t, na.rm = TRUE))

## between
PD_data_lnRR %>%
  summarize(Q1 = quantile(PD_b, probs = 0.25),
            medium = quantile(PD_b, probs = 0.50),
            Q3 = quantile(PD_b, probs = 0.75),
            mean = mean(PD_b, na.rm = TRUE))

```


# Main displays

## Fig 1

Understand effect size heterogeneity and generality from the perspective of PIs and PDs. 

```{r PD, echo = T, warning=FALSE}
############################################		
######## Simulate some meta-analytic data
############################################

set.seed(2024)

# Parameters	
mu = 0.5  									   # Mean effect size. For example SMD. This is the mean contrast between two groups
tau = 0.05  									   # Between-study variance
obs = 0.6                                      # Within study variance 
n = 50                                       # Number of studies
k = 100                                      # Number of effect sizes
vi = rgamma(k, shape = 0.5, scale = 0.1)	   # Effect size sampling variance. Sample from a gamma distribution

# Simulated effect size data
yi = mu + rep(rnorm(n, 0, sd = sqrt(tau)), k/n) + rnorm(k,0, obs) + rnorm(k, 0, sd = sqrt(vi))

# Create data
dat <- data.frame(yi = yi, vi = vi, study = rep(1:n, length = k), within = 1:k)

# Model
mod_sim <- rma.mv(yi, vi, random = list(~ 1 | study, ~1|within), data = dat, method = "REML")


# Get the necessary data
pred_dens_data <- pred_dist_data(mod_sim)[-2,]
pred_dens_data$group[1] <- "Between-study" 
pred_dens_data$group[2] <- "Total"
	
# Calculate what proportion of effect sizes are beyond a biological threshold (in this case SMD = 0.2) for each of the two levels.
pred_dens_data$threshold <- propT_beyond(pred_dens_data, df = mod_sim$k.all - 1, threshold = mod_sim$ci.lb, tail = "above")

mod_resultsdata <- mod_results(mod_sim, mod = "1", group = "study")$mod_table
# forest
p1 <- orchard_plot(mod_sim, mod = "1", xlab = "Predicted effect size", group = "study", angle = 45, k.pos = "left", alpha = 1) + 
	        ylim(-1.5, 2.5) +  
					geom_abline(intercept = mod_resultsdata$lowerPR, slope = 0, linetype = 2,  colour = "red") + 
					geom_abline(intercept = mod_resultsdata$upperPR, slope = 0, linetype = 2,  colour = "red") + 
     				theme(plot.margin = unit(c(0,0,0,0), 'lines'),
					  axis.title = element_text(size = 15, face = "bold"),
					  axis.text = element_text(size = 15, color = "black"),
					  axis.text.y = element_blank(),
					  axis.ticks.y = element_blank(),
					  #legend.background = element_rect(fill = alpha("white", 0)),
            legend.key = element_rect(fill = alpha("white", 0)),
            panel.background = element_rect(fill = alpha("#D7C6CA", 0.3), color = NA),
            plot.background = element_rect(fill = "transparent", color = NA))

# Now create the density plot
	# t distribution
density_between <- data.frame(x = seq(-1.5,2.5,length.out = 1000)) %>% 
	  mutate(density = c(pred_Tdistri(x, df=mod_sim$k.all-1, m=pred_dens_data$mean[1], sd=pred_dens_data$sd[1]))) %>%
	  mutate(group = rep("Between-study", length(x)))
density_total <- data.frame(x = seq(-1.5,2.5,length.out = 1000)) %>% 
	  mutate(density = c(pred_Tdistri(x, df=mod_sim$k.all-1, m=pred_dens_data$mean[2], sd=pred_dens_data$sd[2]))) %>%
	  mutate(group = rep("Total", length(x)))
	#density_dat <- rbind(density_between, density_total)
	#density_dat$group <- as.factor(density_dat$group)
	#density_dat$group <- factor(density_dat$group, levels = c("Total", "Between-study"))
	
	
p2 <- ggplot() +
	  geom_area(data = density_between, aes(x = x, y = density, fill = "Between-study"), alpha = 0.3) +
	  geom_area(data = density_total, aes(x = x, y = density, fill = "Total"), alpha = 0.3) +
	  #scale_fill_manual(values = c("#D95F02", "#1B9E77"), labels = c(bquote("Total:"~paste(italic(sigma)[total]^2)~"= 0.37,"~paste(italic(I)[total]^2)~"= 100%,"~paste(italic(M)[total])~"= 0.46"), bquote("Between-study:"~paste(italic(sigma)[between]^2)~"= 0.08,"~paste(italic(I)[between]^2)~"= 20%,"~paste(italic(M)[between])~"= 0.21"))) + 
  scale_fill_manual(values = c("#C17F9E", "#8BACD1")) +
	  stat_function(fun = pred_Tdistri_shaded, args = list(df = mod_sim$k.all - 1, m = pred_dens_data$mean[1], sd = pred_dens_data$sd[1], threshold = mod_sim$ci.lb),
	                geom = "area", fill = "#C17F9E", alpha = 0.5) +
	  stat_function(fun = pred_Tdistri_shaded, args = list(df = mod_sim$k.all - 1, m = pred_dens_data$mean[2], sd = pred_dens_data$sd[2], threshold = mod_sim$ci.lb),
	                geom = "area", fill = "#8BACD1",  alpha = 0.5) +
	  theme_bw() + xlim(-1.5, 2.5) + labs(fill = "Context") +
	  geom_vline(xintercept = 0, linetype = 2,  colour = "black") +
	  geom_vline(xintercept = mod_resultsdata$lowerPR, linetype = 2,  colour = "red") + 
	  geom_vline(xintercept = mod_resultsdata$upperPR, linetype = 2,  colour = "red") + 
	  annotate("text", x = pred_dens_data$mean + 0.03, y = c(1.5, 0.5), label = paste0(round(pred_dens_data$threshold,0), "%"), size = 5) + 
	  theme(legend.position= c(0, 1), 
	        legend.justification = c(0, 1), 
	        legend.background = element_blank(),
	        legend.text = element_text(size = 10),
	        legend.title = element_text(size = 15, face = "bold"),
	        axis.text = element_blank(),
	        axis.title = element_blank(),
	        axis.ticks = element_blank(),
	        plot.margin = unit(c(0,0,0,0), 'lines'),
	        panel.background = element_rect(fill = alpha("#D7C6CA", 0.3), color = NA),
          plot.background = element_rect(fill = "transparent", color = NA)) 
	
## normal distribution	
dens_plot2 <- ggplot(data = data.frame(x=c(-1.5,2.5)), aes(x = x, color = group, fill = group)) +
	        pred_distri(pred_dens_data) + 
	        scale_fill_manual(values = c("#D95F02", "#1B9E77"), labels = c(bquote("Total:"~paste(italic(sigma)[total]^2)~"= 0.37,"~paste(italic(I)[total]^2)~"= 100%,"~paste(italic(M)[total])~"= 0.46"), bquote("Between-study:"~paste(italic(sigma)[between]^2)~"= 0.08,"~paste(italic(I)[between]^2)~"= 20%,"~paste(italic(M)[between])~"= 0.21"))) + 
	        scale_color_manual(values = c("#D95F02", "#1B9E77"), labels = c(bquote("Total:"~paste(italic(sigma)[total]^2)~"= 0.37,"~paste(italic(I)[total]^2)~"= 100%,"~paste(italic(M)[total])~"= 0.46"), bquote("Between-study:"~paste(italic(sigma)[between]^2)~"= 0.08,"~paste(italic(I)[between]^2)~"= 20%,"~paste(italic(M)[between])~"= 0.21"))) +
	        stat_function(fun = pred_distri_shaded, args = list(m = pred_dens_data$mean[1], sd = pred_dens_data$sd[1], threshold = mod_sim$ci.lb),
	                geom = "area", fill = "#1B9E77", color = "#1B9E77", alpha = 0.6) +
	        stat_function(fun = pred_distri_shaded, args = list(m = pred_dens_data$mean[2], sd = pred_dens_data$sd[2], threshold = mod_sim$ci.lb),
	                geom = "area", fill = "#D95F02", color = "#D95F02", alpha = 0.6) +
	         #theme(legend.text.align = 0) +
					 theme_bw() + xlim(-1.5, 2.5) + labs(fill = "Stratum", color = "Stratum") +
					 geom_vline(xintercept = 0, linetype = 2,  colour = "black") +
					 geom_vline(xintercept = mod_resultsdata$lowerPR, linetype = 2,  colour = "red") + 
					  geom_vline(xintercept = mod_resultsdata$upperPR, linetype = 2,  colour = "red") + 
					 annotate("text", x = pred_dens_data$mean, y = c(0.8, 0.5), label = paste0(pred_dens_data$threshold, "%"), size = 5) + 
					 theme(legend.position= c(0, 1), 
			  				legend.justification = c(0, 1), 
			  				legend.background = element_blank(),
							legend.text = element_text(size = 10),
							legend.title = element_text(size = 15, face = "bold"),
			  				axis.text = element_blank(),
			  				axis.title = element_blank(),
			  				axis.ticks = element_blank(),
			  				plot.margin = unit(c(0,0,0,0), 'lines')) 

# assemble
png(filename = "fig 1.png", width = 8, height = 8, units = "in", type = "windows", res = 600)
p2 / p1 + plot_layout(heights = c(1, 0.5)) + plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text(size = 16))
dev.off()


```


## Fig 2

```{r}
# scenario where when significant effect exists
#PD_data_b <- filter(PD_data, sigma2_b < sigma2_w) 
PD_data_b <- filter(PD_data, beta.p < 0.05) 

# plot
df <- filter(PD_data_b, abs(beta) < 5) %>% arrange(beta) # potential outlier beta
#df <- filter(PD_data_b, PIL_b * PIU_b > 0)
df$id <- seq(1,nrow(df),by=1)


p1 <- df %>% ggplot() +
   geom_hline(yintercept = 0, color = "blue", linetype = "dotted") +
   geom_linerange(aes(x = id, ymin = PIL_b, ymax = PIU_b, color = sig_b), alpha = 0.5) + 
  geom_point(aes(x = id, y = beta, color = sig_b), alpha = 0.4, stroke = 3) + 
  #scale_color_manual(values = c("#3F6561", "#FCB462")) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_bw() + 
  theme(
    legend.position = c(1, 0), 
    legend.justification = c(1, 0),
    legend.direction = 'horizontal',
    axis.text = element_text(size = 22, color = "black"),
    axis.title = element_text(size = 22, face = "bold"),
    legend.title = element_text(size = 20), 
    legend.text = element_text(size = 20),
    legend.background = element_rect(fill = alpha("white", 0)),
    legend.key = element_rect(fill = alpha("white", 0)),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.background = element_rect(fill = alpha("#D7C6CA", 0.3), color = NA),
    plot.background = element_rect(fill = "transparent", color = NA)
  ) + 
  labs(x = "Meta-analyes", y = "Predicted effect sizes in new studies", color = "")

p2 <- ggplot(df, aes(x = id, y = PD_b/100)) +
  geom_segment(aes(x = id, xend = id, y = 0/100, yend = PD_b/100, color = sig_b), alpha = 0.2) +
  geom_point(aes(color = sig_b), alpha = 0.4, stroke = 3) +
  scale_size_continuous(range = c(1, 5)) + 
  scale_y_continuous(limits = c(0/100, 100/100), breaks = seq(0/100,100/100,25/100), labels = scales::percent, expand = c(0, 0)) +
  guides(color = "none") + 
  theme_bw() + 
  theme(legend.position=c(1,0), 
        legend.justification=c(1,0),
        legend.direction='horizontal',
        axis.text = element_text(size = 22, color = "black"),
        axis.title = element_text(size = 22, face = "bold"),
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 15)) +
  theme(legend.background=element_rect(fill = alpha("white", 0)),
        legend.key = element_rect(fill = alpha("white", 0)),
        panel.background = element_rect(fill = alpha("#D7C6CA", 0.3), color = NA), # #FFE8CE
        plot.background = element_rect(fill = "transparent", color = NA)
        ) +
  labs(x = "Number of meta-analyes", y = "Study-level PD above meaningful thresholds", color = "")


png(filename = "fig 2.png", width = 12, height = 16, units = "in", type = "windows", res = 600)
p1 / p2 + plot_layout(heights = c(1, 1)) + plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text(size = 25))
dev.off()

```


# Supplements

## Fig S1

```{r}
# data frame
df_1x1 <- data_1x1(
  array_1 = PD_data$PD_t, 
  array_2 = PD_data$PD_b,
  jit_distance = .2,
  jit_seed = 321) 
# plot
paired_PD <- raincloud_1x1_repmes(
  data = df_1x1, 
  colors = brewer.pal(n = 8, name = "Dark2")[3:4],
  fills = brewer.pal(n = 8, name = "Dark2")[3:4],
  line_color = 'gray',
  line_alpha = .3,
  size = 1,
  alpha = .5,
  align_clouds = FALSE) +

scale_x_continuous(breaks=c(1,2), 
                   labels=c("Total level", "Study level")
                   ) +
  xlab("Generality at different levels") +
  ylab(expression(paste("PD"~">"~"meaningful thresholds"))) + 
  theme_bw() + 
  theme(axis.text = element_text(size = 12, color = "black"), 
        axis.title = element_text(size = 12, color = "black"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank()) 


png(filename = "Fig S1.png", width = 6, height = 6, units = "in", type = "windows", res = 600)
paired_PD
dev.off()

```


## Fig S2

```{r}
# scenario where when significant effect exists
PD_data_b <- filter(PD_data, beta.p < 0.05) 
# subset of SMD
PD_data_b_SMD <- filter(PD_data_b, es == "SMD")

# plot
df <- filter(PD_data_b_SMD, abs(beta) < 5) %>% arrange(beta) # potential outlier
df$id <- seq(1,nrow(df),by=1)


p1 <- df %>% ggplot() +
   geom_hline(yintercept = 0, color = "black", linetype = "dotted") +
   geom_linerange(aes(x = id, ymin = PIL_b, ymax = PIU_b, color = sig_b), alpha = 0.5) + 
  geom_point(aes(x = id, y = beta, color = sig_b), alpha = 0.4, stroke = 3) + 
  scale_color_manual(values = c("#1B9E77", "#D95F02")) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_bw() + 
  theme(
    legend.position = c(1, 0), 
    legend.justification = c(1, 0),
    legend.direction = 'horizontal',
    axis.text = element_text(size = 22, color = "black"),
    axis.title = element_text(size = 22, face = "bold"),
    plot.title = element_text(size = 22, face = "bold"),
    legend.title = element_text(size = 20), 
    legend.text = element_text(size = 20),
    legend.background = element_rect(fill = alpha("white", 0)),
    legend.key = element_rect(fill = alpha("white", 0)),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.background = element_rect(fill = alpha("#D7C6CA", 0), color = NA),
    plot.background = element_rect(fill = "transparent", color = NA)
  ) + 
  labs(x = "Meta-analyes", y = "Predicted effect sizes in new studies", color = "", title = "Standardized mean difference (SMD)")

p2 <- ggplot(df, aes(x = id, y = PD_b/100)) +
  geom_segment(aes(x = id, xend = id, y = 0/100, yend = PD_b/100, color = sig_b), alpha = 0.2) +
  geom_point(aes(color = sig_b), alpha = 0.4, stroke = 3) +
  scale_color_manual(values = c("#1B9E77", "#D95F02")) +
  scale_size_continuous(range = c(1, 5)) + 
  scale_y_continuous(limits = c(0/100, 100/100), breaks = seq(0/100,100/100,25/100), labels = scales::percent, expand = c(0, 0)) +
  guides(color = "none") + 
  theme_bw() + 
  theme(legend.position=c(1,0), 
        legend.justification=c(1,0),
        legend.direction='horizontal',
        axis.text = element_text(size = 22, color = "black"),
        axis.title = element_text(size = 22, face = "bold"),
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 15)) +
  theme(legend.background=element_rect(fill = alpha("white", 0)),
        legend.key = element_rect(fill = alpha("white", 0)),
        panel.background = element_rect(fill = alpha("#D7C6CA", 0), color = NA), # #FFE8CE
        plot.background = element_rect(fill = "transparent", color = NA)
        ) +
  labs(x = "Number of meta-analyes", y = "Study-level PD above meaningful thresholds", color = "")


png(filename = "Fig S2.png", width = 12, height = 16, units = "in", type = "windows", res = 600)
p1 / p2 + plot_layout(heights = c(1.2, 1)) + plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text(size = 25))
dev.off()

```

## Fig S3

```{r}
# scenario where when significant effect exists
PD_data_b <- filter(PD_data, beta.p < 0.05) 
# subset of Zr
PD_data_b_Zr <- filter(PD_data_b, es == "Zr")

# plot
df <- filter(PD_data_b_Zr, abs(beta) < 5) %>% arrange(beta) # potential outlier
df$id <- seq(1,nrow(df),by=1)


p1 <- df %>% ggplot() +
   geom_hline(yintercept = 0, color = "black", linetype = "dotted") +
   geom_linerange(aes(x = id, ymin = PIL_b, ymax = PIU_b, color = sig_b), alpha = 0.5) + 
  geom_point(aes(x = id, y = beta, color = sig_b), alpha = 0.4, stroke = 3) + 
  scale_color_manual(values = c("#7570B3", "#E7298A")) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_bw() + 
  theme(
    legend.position = c(1, 0), 
    legend.justification = c(1, 0),
    legend.direction = 'horizontal',
    axis.text = element_text(size = 22, color = "black"),
    axis.title = element_text(size = 22, face = "bold"),
    plot.title = element_text(size = 22, face = "bold"),
    legend.title = element_text(size = 20), 
    legend.text = element_text(size = 20),
    legend.background = element_rect(fill = alpha("white", 0)),
    legend.key = element_rect(fill = alpha("white", 0)),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.background = element_rect(fill = alpha("#D7C6CA", 0), color = NA),
    plot.background = element_rect(fill = "transparent", color = NA)
  ) + 
  labs(x = "Meta-analyes", y = "Predicted effect sizes in new studies", color = "", title = "Fisher's z transformation of correlation coefficient (Fisher's Zr)")

p2 <- ggplot(df, aes(x = id, y = PD_b/100)) +
  geom_segment(aes(x = id, xend = id, y = 0/100, yend = PD_b/100, color = sig_b), alpha = 0.2) +
  geom_point(aes(color = sig_b), alpha = 0.4, stroke = 3) +
  scale_color_manual(values = c("#7570B3", "#E7298A")) +
  scale_size_continuous(range = c(1, 5)) + 
  scale_y_continuous(limits = c(0/100, 100/100), breaks = seq(0/100,100/100,25/100), labels = scales::percent, expand = c(0, 0)) +
  guides(color = "none") + 
  theme_bw() + 
  theme(legend.position=c(1,0), 
        legend.justification=c(1,0),
        legend.direction='horizontal',
        axis.text = element_text(size = 22, color = "black"),
        axis.title = element_text(size = 22, face = "bold"),
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 15)) +
  theme(legend.background=element_rect(fill = alpha("white", 0)),
        legend.key = element_rect(fill = alpha("white", 0)),
        panel.background = element_rect(fill = alpha("#D7C6CA", 0), color = NA), # #FFE8CE
        plot.background = element_rect(fill = "transparent", color = NA)
        ) +
  labs(x = "Number of meta-analyes", y = "Study-level PD above meaningful thresholds", color = "")


png(filename = "Fig S3.png", width = 12, height = 16, units = "in", type = "windows", res = 600)
p1 / p2 + plot_layout(heights = c(1.2, 1)) + plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text(size = 25))
dev.off()

```

## Fig S4

```{r}
# scenario where when significant effect exists
PD_data_b <- filter(PD_data, beta.p < 0.05) 
# subset of lnRR
PD_data_b_lnRR <- filter(PD_data_b, es == "lnRR")

# plot
df <- filter(PD_data_b_lnRR, abs(beta) < 5) %>% arrange(beta) # potential outlier
df$id <- seq(1,nrow(df),by=1)


p1 <- df %>% ggplot() +
   geom_hline(yintercept = 0, color = "black", linetype = "dotted") +
   geom_linerange(aes(x = id, ymin = PIL_b, ymax = PIU_b, color = sig_b), alpha = 0.5) + 
  geom_point(aes(x = id, y = beta, color = sig_b), alpha = 0.4, stroke = 3) + 
  scale_color_manual(values = c("#66A61E", "#E6AB02")) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_bw() + 
  theme(
    legend.position = c(1, 0), 
    legend.justification = c(1, 0),
    legend.direction = 'horizontal',
    axis.text = element_text(size = 22, color = "black"),
    axis.title = element_text(size = 22, face = "bold"),
    plot.title = element_text(size = 22, face = "bold"),
    legend.title = element_text(size = 20), 
    legend.text = element_text(size = 20),
    legend.background = element_rect(fill = alpha("white", 0)),
    legend.key = element_rect(fill = alpha("white", 0)),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.background = element_rect(fill = alpha("#D7C6CA", 0), color = NA),
    plot.background = element_rect(fill = "transparent", color = NA)
  ) + 
  labs(x = "Meta-analyes", y = "Predicted effect sizes in new studies", color = "", title = "Log response ratio (lnRR)")

p2 <- ggplot(df, aes(x = id, y = PD_b/100)) +
  geom_segment(aes(x = id, xend = id, y = 0/100, yend = PD_b/100, color = sig_b), alpha = 0.2) +
  geom_point(aes(color = sig_b), alpha = 0.4, stroke = 3) +
  scale_color_manual(values = c("#66A61E", "#E6AB02")) +
  scale_size_continuous(range = c(1, 5)) + 
  scale_y_continuous(limits = c(0/100, 100/100), breaks = seq(0/100,100/100,25/100), labels = scales::percent, expand = c(0, 0)) +
  guides(color = "none") + 
  theme_bw() + 
  theme(legend.position=c(1,0), 
        legend.justification=c(1,0),
        legend.direction='horizontal',
        axis.text = element_text(size = 22, color = "black"),
        axis.title = element_text(size = 22, face = "bold"),
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 15)) +
  theme(legend.background=element_rect(fill = alpha("white", 0)),
        legend.key = element_rect(fill = alpha("white", 0)),
        panel.background = element_rect(fill = alpha("#D7C6CA", 0), color = NA), # #FFE8CE
        plot.background = element_rect(fill = "transparent", color = NA)
        ) +
  labs(x = "Number of meta-analyes", y = "Study-level PD above meaningful thresholds", color = "")


png(filename = "Fig S4.png", width = 12, height = 16, units = "in", type = "windows", res = 600)
p1 / p2 + plot_layout(heights = c(1.2, 1)) + plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text(size = 25))
dev.off()

```


## Fig S5

```{r}
# subset of SMD and Zr
PD_data_SMD_Zr <- filter(PD_data, es == "SMD" | es == "Zr")
# add PD using Cohen's small effect as the threshold
PD_data_SMD_Zr$PD_t_Cohen <- filter(threshold_df_SMD_Zr, group == "PD_t")$threshold_Cohen # total
PD_data_SMD_Zr$PD_b_Cohen <- filter(threshold_df_SMD_Zr, group == "PD_b")$threshold_Cohen # between
PD_data_SMD_Zr$PD_w_Cohen <- filter(threshold_df_SMD_Zr, group == "PD_w")$threshold_Cohen # between

# scenario where when significant effect exists
PD_data_SMD_Zr_sig <- filter(PD_data_SMD_Zr, beta.p < 0.05) 

# plot
df <- filter(PD_data_SMD_Zr_sig, abs(beta) < 5) %>% arrange(beta) # potential outlier
df$id <- seq(1,nrow(df),by=1)


p1 <- df %>% ggplot() +
   geom_hline(yintercept = 0, color = "black", linetype = "dotted") +
   geom_linerange(aes(x = id, ymin = PIL_b, ymax = PIU_b, color = sig_b), alpha = 0.5) + 
  geom_point(aes(x = id, y = beta, color = sig_b), alpha = 0.4, stroke = 3) + 
  scale_color_manual(values = c("#A6761D", "#666666")) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_bw() + 
  theme(
    legend.position = c(1, 0), 
    legend.justification = c(1, 0),
    legend.direction = 'horizontal',
    axis.text = element_text(size = 22, color = "black"),
    axis.title = element_text(size = 22, face = "bold"),
    plot.title = element_text(size = 22, face = "bold"),
    legend.title = element_text(size = 20), 
    legend.text = element_text(size = 20),
    legend.background = element_rect(fill = alpha("white", 0)),
    legend.key = element_rect(fill = alpha("white", 0)),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.background = element_rect(fill = alpha("#D7C6CA", 0), color = NA),
    plot.background = element_rect(fill = "transparent", color = NA)
  ) + 
  labs(x = "Meta-analyes", y = "Predicted effect sizes in new studies", color = "", title = "Cohen's 'small effect' as meaningful threshold")

p2 <- ggplot(df, aes(x = id, y = PD_b/100)) +
  geom_segment(aes(x = id, xend = id, y = 0/100, yend = PD_b/100, color = sig_b), alpha = 0.2) +
  geom_point(aes(color = sig_b), alpha = 0.4, stroke = 3) +
  scale_color_manual(values = c("#A6761D", "#666666")) +
  scale_size_continuous(range = c(1, 5)) + 
  scale_y_continuous(limits = c(0/100, 100/100), breaks = seq(0/100,100/100,25/100), labels = scales::percent, expand = c(0, 0)) +
  guides(color = "none") + 
  theme_bw() + 
  theme(legend.position=c(1,0), 
        legend.justification=c(1,0),
        legend.direction='horizontal',
        axis.text = element_text(size = 22, color = "black"),
        axis.title = element_text(size = 22, face = "bold"),
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 15)) +
  theme(legend.background=element_rect(fill = alpha("white", 0)),
        legend.key = element_rect(fill = alpha("white", 0)),
        panel.background = element_rect(fill = alpha("#D7C6CA", 0), color = NA), # #FFE8CE
        plot.background = element_rect(fill = "transparent", color = NA)
        ) +
  labs(x = "Number of meta-analyes", y = "Study-level PD above meaningful thresholds", color = "")


png(filename = "Fig S5.png", width = 12, height = 16, units = "in", type = "windows", res = 600)
p1 / p2 + plot_layout(heights = c(1.2, 1)) + plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text(size = 25))
dev.off()

```
